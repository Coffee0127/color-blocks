<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Color Craft</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
<div class="container">
  <div id="screen1" class="screen d-flex flex-column align-items-center">
    <h1>Color Selection</h1>
    <div class="btn-group">
      <button class="color-btn btn btn-danger" data-color="red">Red</button>
      <button class="color-btn btn btn-success" data-color="green">Green</button>
      <button class="color-btn btn btn-warning" data-color="yellow">Yellow</button>
      <button class="color-btn btn btn-primary" data-color="blue">Blue</button>
    </div>
  </div>

  <div id="screen2" class="screen d-none flex-column align-items-center">
    <h1>Difficulty Selection</h1>
    <div class="btn-group">
      <button class="difficulty-btn btn btn-secondary" data-difficulty="low">Low</button>
      <button class="difficulty-btn btn btn-secondary" data-difficulty="medium">Medium</button>
      <button class="difficulty-btn btn btn-secondary" data-difficulty="high">High</button>
    </div>
  </div>

  <div id="screen3" class="screen d-none flex-column align-items-center">
    <h2>Difficulty: <span id="selectedDifficulty"></span></h2>
    <div id="timer" class="mt-2"></div>
    <button id="finishBtn" class="btn btn-primary mt-2">Finish</button>
    <div class="text-center mt-2">
      <div>Make the lightest color start from here.</div>
      <div class="pl-3">&#8681;</div>
    </div>
    <canvas id="colorBlocks" style="max-height: 500px;"></canvas>
  </div>

  <div id="screen4" class="screen d-none flex-column align-items-center">
    <h1>Result</h1>
    <div id="result"></div>
    <button id="restartBtn" class="btn btn-primary mt-2">Restart</button>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
  const MAX_AVAILABLE_COLOR_COUNT = 48;
  const COLOR_RGB = {
    "red": "255, 0, 0",
    "green": "0, 255, 0",
    "yellow": "255, 255, 0",
    "blue": "0, 0, 255"
  };

  // Global variables
  let selectedColor = "";
  let selectedDifficulty = "";
  let selectedIndex = -1;
  let colorBlocksOrder = [];
  let timerInterval;
  let colorBlocksChart;
  let originalRadius;

  // Screen 1: Color Selection
  $(".color-btn").click(function () {
    selectedColor = $(this).data("color");
    showScreen2();
  });

  function showScreen2() {
    hideAllScreen();
    showScreen("screen2");
  }

  // Screen 2: Difficulty Selection
  $(".difficulty-btn").click(function () {
    selectedDifficulty = $(this).data("difficulty");
    showScreen3();
  });

  function showScreen3() {
    hideAllScreen();
    showScreen("screen3");
    generateColorBlocks();
    startTimer();
  }

  // Screen 3: Color Blocks
  function generateColorBlocks() {
    let maxBlocksCount;
    switch (selectedDifficulty) {
      case "low":
        maxBlocksCount = 12;
        break;
      case "medium":
        maxBlocksCount = 24;
        break;
      case "high":
        maxBlocksCount = 48;
        break;
    }

    const availableColorBlocks = [];
    for (let i = 1; i <= MAX_AVAILABLE_COLOR_COUNT; i++) {
      availableColorBlocks.push(i);
    }

    $('#selectedDifficulty').text(selectedDifficulty);

    for (let i = 1; i <= maxBlocksCount; i++) {
      const randomIndex = Math.floor(Math.random() * availableColorBlocks.length);
      const blockSerial = availableColorBlocks.splice(randomIndex, 1)[0];
      colorBlocksOrder.push(blockSerial);
    }

    drawBlocks();
  }

  function drawBlocks() {
    colorBlocksChart?.destroy();

    const chartData = colorBlocksOrder.map(_ => 1);
    const selectedColorRGB = COLOR_RGB[selectedColor];
    const chartBackgroundColor = colorBlocksOrder.map(blockSerial => {
      const selectedColorOpacity = 0.1 + (blockSerial / MAX_AVAILABLE_COLOR_COUNT) * 0.9;
      return `rgba(${selectedColorRGB}, ${selectedColorOpacity})`;
    });

    const ctx = document.getElementById('colorBlocks');
    const data = {
      datasets: [{
        // data: colorBlocksOrder,
        data: chartData,
        backgroundColor: chartBackgroundColor
      }]
    };
    const config = {
      type: 'pie',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            enabled: true,
            usePointStyle: true,
            callbacks: {
              // for debugging
              // label: context => {
              //   const opacity = context.element.options.backgroundColor
              //     .replace(`rgba(${selectedColorRGB}, `, '')
              //     .replace(')', '');
              //   return Math.round(opacity * 100) / 100;
              // }
              label: context => " " // show selected color only
            }
          }
        },
        layout: {
          padding: 5
        },
        hoverOffset: 5,
        hoverBorderColor: '#adb5bd',
        hoverBorderWidth: 2,
        onClick: (e, elements, chart) => {
          const clickedElement = elements[0];
          if (clickedElement) {
            const currentIndex = clickedElement.index;

            // click itself, restore every thing
            if (selectedIndex === currentIndex) {
              clickedElement.element.outerRadius = originalRadius;
              selectedIndex = -1;
              return;
            }

            // click the second color block
            if (selectedIndex !== -1) {
              [colorBlocksOrder[currentIndex], colorBlocksOrder[selectedIndex]] = [colorBlocksOrder[selectedIndex], colorBlocksOrder[currentIndex]];
              const backgroundColors = chart.data.datasets[0].backgroundColor;
              [backgroundColors[currentIndex], backgroundColors[selectedIndex]] = [backgroundColors[selectedIndex], backgroundColors[currentIndex]];
              chart.tooltip.opacity = 0;
              chart.update();
              selectedIndex = -1;
              return;
            }

            // choose the first color block
            selectedIndex = currentIndex;
            originalRadius = clickedElement.element.outerRadius;
            chart.tooltip.opacity = 1;
            clickedElement.element.outerRadius += 5;
          }
        }
      }
    };

    colorBlocksChart = new Chart(ctx, config);
  }

  function startTimer() {
    let timeLeft = 120;
    $("#timer").text(`Time Left: ${timeLeft} seconds`);

    timerInterval = setInterval(function () {
      timeLeft--;
      $("#timer").text(`Time Left: ${timeLeft} seconds`);

      if (timeLeft === 0) {
        clearInterval(timerInterval);
        showScreen4();
      }
    }, 1000);
  }

  $("#finishBtn").click(function () {
    clearInterval(timerInterval);
    showScreen4();
  });

  function showScreen4() {
    hideAllScreen();
    showScreen("screen4");
    calculateResult();
  }

  // Screen 4: Result
  function calculateResult() {
    let correctCount = 0;
    const correctOrder = [...colorBlocksOrder].sort((a, b) => a - b);
    for (let i = 0; i < correctOrder.length; i++) {
      if (colorBlocksOrder[i] === correctOrder[i]) {
        correctCount++;
      }
    }

    let accuracy = `${correctCount} / ${colorBlocksOrder.length}`;
    $("#result").text(`Accuracy: ${accuracy}`);
  }

  // Restart
  $("#restartBtn").click(function () {
    resetGame();
    showScreen1();
  });

  function resetGame() {
    selectedColor = "";
    selectedDifficulty = "";
    colorBlocksOrder = [];
    selectedIndex = -1;
    clearInterval(timerInterval);
    colorBlocksChart?.destroy();
    $("#timer").empty();
    $("#result").empty();
  }

  function showScreen1() {
    hideAllScreen();
    showScreen("screen1");
  }

  function showScreen(screenId) {
    $(`#${screenId}`).removeClass("d-none").addClass("d-flex");
  }

  function hideAllScreen() {
    $(".screen").addClass("d-none").removeClass("d-flex");
  }
</script>
</body>

</html>
